{% extends "base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="profile-page">
    <div class="page-header">
        <h1 class="page-title">Profile Settings</h1>
        <p class="page-subtitle">Manage your account and preferences</p>
    </div>
    
    <div class="profile-grid">
        <!-- Profile Info Card -->
        <div class="profile-card">
            <div class="card-header">
                <h3><i class="bi bi-person-circle"></i> Profile Information</h3>
            </div>
            <div class="card-body">
                <div class="profile-avatar">
                    <div class="avatar-circle">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="avatar-info">
                        <h4>{{ current_user.username }}</h4>
                        <span class="badge bg-{{ 'success' if current_user.role == 'admin' else 'primary' }}">
                            {{ current_user.role|title }}
                        </span>
                    </div>
                </div>
                
                <div class="profile-details">
                    <div class="detail-item">
                        <span class="label">Email</span>
                        <span class="value">{{ current_user.email }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Member Since</span>
                        <span class="value">{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Last Login</span>
                        <span class="value">{{ current_user.last_login.strftime('%B %d, %Y %H:%M') if current_user.last_login else 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Account Status</span>
                        <span class="value">
                            <span class="status-badge {{ 'active' if current_user.is_active else 'inactive' }}">
                                {{ 'Active' if current_user.is_active else 'Inactive' }}
                            </span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Change Password Card -->
        <div class="profile-card">
            <div class="card-header">
                <h3><i class="bi bi-key"></i> Change Password</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('auth.change_password') }}">
                    {{ form.hidden_tag() if form else '' }}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" name="current_password" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                            <input type="password" name="new_password" class="form-control" required minlength="8">
                        </div>
                        <small class="text-muted">Minimum 8 characters</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                            <input type="password" name="confirm_password" class="form-control" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Update Password
                    </button>
                </form>
            </div>
        </div>
        
        <!-- API Keys Card -->
        <div class="profile-card wide">
            <div class="card-header">
                <h3><i class="bi bi-key-fill"></i> API Keys</h3>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
                    <i class="bi bi-plus-lg"></i> Generate New Key
                </button>
            </div>
            <div class="card-body">
                {% if api_keys %}
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Key (Partial)</th>
                            <th>Created</th>
                            <th>Last Used</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in api_keys %}
                        <tr>
                            <td>{{ key.name }}</td>
                            <td><code>{{ key.key[:8] }}...{{ key.key[-4:] }}</code></td>
                            <td>{{ key.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>{{ key.last_used.strftime('%Y-%m-%d %H:%M') if key.last_used else 'Never' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if key.is_active else 'danger' }}">
                                    {{ 'Active' if key.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="revokeKey('{{ key.id }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-key"></i>
                    <p>No API keys generated</p>
                    <small>Generate an API key to access the detection endpoints</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Notification Preferences -->
        <div class="profile-card">
            <div class="card-header">
                <h3><i class="bi bi-bell"></i> Notification Preferences</h3>
            </div>
            <div class="card-body">
                <form id="notification-form">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="emailAlerts" checked>
                        <label class="form-check-label" for="emailAlerts">
                            Email alerts for critical threats
                        </label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="dailyDigest">
                        <label class="form-check-label" for="dailyDigest">
                            Daily security digest
                        </label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="weeklyReport" checked>
                        <label class="form-check-label" for="weeklyReport">
                            Weekly analytics report
                        </label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="browserNotifications">
                        <label class="form-check-label" for="browserNotifications">
                            Browser push notifications
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Save Preferences
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="profile-card danger">
            <div class="card-header">
                <h3><i class="bi bi-exclamation-triangle"></i> Danger Zone</h3>
            </div>
            <div class="card-body">
                <div class="danger-item">
                    <div class="danger-info">
                        <h4>Export My Data</h4>
                        <p>Download all your data including alerts and settings</p>
                    </div>
                    <a href="{{ url_for('auth.export_my_data') }}" class="btn btn-outline-warning">
                        <i class="bi bi-download"></i> Export
                    </a>
                </div>
                
                <div class="danger-item">
                    <div class="danger-info">
                        <h4>Delete Account</h4>
                        <p>Permanently delete your account and all associated data</p>
                    </div>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Key Modal -->
<div class="modal fade" id="generateKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-key me-2"></i>Generate API Key</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.generate_api_key') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label">Key Name</label>
                        <input type="text" name="key_name" class="form-control" placeholder="e.g., Production Server" required>
                        <small class="text-muted">Give your key a descriptive name to identify its purpose</small>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> The API key will only be shown once after generation. Make sure to copy it!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-2"></i>Generate Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle"></i> Delete Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you absolutely sure you want to delete your account?</p>
                <p class="text-danger">This action cannot be undone. All your data will be permanently deleted.</p>
                <div class="form-group">
                    <label class="form-label">Type your username to confirm:</label>
                    <input type="text" id="confirm-username" class="form-control" placeholder="{{ current_user.username }}">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete" disabled>Delete Account</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('confirm-username').addEventListener('input', function() {
        const deleteBtn = document.getElementById('confirm-delete');
        deleteBtn.disabled = this.value !== '{{ current_user.username }}';
    });
    
    function revokeKey(keyId) {
        if (confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) {
            // Create and submit a form for POST request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/auth/profile/revoke-api-key/' + keyId;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}
